<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Changes End of Unit Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .math { font-style: italic; font-family: serif; }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Hide scrollbar for cleaner look in modals */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <!-- Header & Timer -->
    <div class="sticky top-0 z-50 bg-white border-b shadow-sm p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-blue-600 transition" title="AI Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1-1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <h1 class="text-xl font-bold text-gray-800">Energy Changes End of Unit Assessment</h1>
            </div>
            <div id="timer-display" class="bg-blue-600 text-white px-4 py-2 rounded-full font-mono font-bold text-lg">
                30:00
            </div>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4 mt-6">
        
        <!-- Introduction Box -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Instructions</h2>
            <p class="text-gray-600 mb-4">Complete all five questions. For long-form questions, use specific scientific terminology as requested in the prompts. Once finished, click "Submit for AI Grading" at the bottom. You have 30 minutes.</p>
            <div class="flex gap-4 items-center">
                <button id="start-btn" onclick="startTest()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition shadow-sm">
                    Start Worksheet
                </button>
                <p id="status-msg" class="text-sm font-medium text-gray-500 italic"></p>
            </div>
        </div>

        <div id="questions-container" class="opacity-40 pointer-events-none transition-opacity duration-500">
            
            <!-- Question 1 -->
            <section class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Question 1 (6 marks) – Comparing Reactivity of Metals</h3>
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">REQUIRED PRACTICAL</span>
                </div>
                <p class="text-gray-700 mb-4">A student investigates the reactivity of different metals by measuring the temperature change when each metal reacts with dilute hydrochloric acid.</p>
                <p class="font-semibold text-gray-800 mb-2">Describe an experiment the student could use to compare the reactivity of magnesium, zinc, and iron.</p>
                <p class="text-sm text-gray-600 mb-4 italic leading-relaxed">Your answer should include: the apparatus used, how the experiment should be carried out, how temperature change is measured and recorded, how the results are used to compare the reactivity of the metals, and a control variable with why it is important.</p>
                <textarea id="q1-input" class="w-full h-48 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Type your experimental method here..."></textarea>
                <div id="q1-feedback" class="mt-4 hidden p-4 rounded-lg"></div>
            </section>

            <!-- Question 2 -->
            <section class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Question 2 (4 marks) – Exothermic Reactions in Everyday Life</h3>
                <p class="text-gray-700 mb-4">Many everyday processes, such as hand warmers and combustion reactions, are exothermic.</p>
                <p class="font-semibold text-gray-800 mb-2">Explain what is meant by an exothermic reaction.</p>
                <p class="text-sm text-gray-600 mb-4 italic leading-relaxed">Your answer should refer to: energy transfer, the temperature of the surroundings, and bond breaking versus bond forming.</p>
                <textarea id="q2-input" class="w-full h-32 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Explain the energy changes..."></textarea>
                <div id="q2-feedback" class="mt-4 hidden p-4 rounded-lg"></div>
            </section>

            <!-- Question 3 -->
            <section class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Question 3 (6 marks) – Bond Energy Calculations in Industry</h3>
                <p class="text-gray-700 mb-4">Ammonia is produced on a large scale in industry using the Haber process: <span class="math font-bold">N₂ + 3H₂ → 2NH₃</span></p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-3 rounded border text-center font-mono text-sm">N≡N = 945 kJ mol⁻¹</div>
                    <div class="bg-gray-50 p-3 rounded border text-center font-mono text-sm">H–H = 436 kJ mol⁻¹</div>
                    <div class="bg-gray-50 p-3 rounded border text-center font-mono text-sm">N–H = 391 kJ mol⁻¹</div>
                </div>

                <div class="space-y-4">
                    <p class="font-semibold text-gray-800 mb-2">Calculate the energy required to break bonds, the energy released when bonds form, and the overall energy change. State if the reaction is exothermic or endothermic with a reason.</p>
                    <textarea id="q3-input" class="w-full h-56 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Show your calculations and final reasoning here..."></textarea>
                </div>
                <div id="q3-feedback" class="mt-4 hidden p-4 rounded-lg"></div>
            </section>

            <!-- Question 4 -->
            <section class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Question 4 (6 marks) – Hydrogen Fuel Cells and Energy Transfer</h3>
                <p class="text-gray-700 mb-4">Hydrogen fuel cells are increasingly used to power electric vehicles because they produce electricity without releasing carbon dioxide.</p>
                <p class="font-semibold text-gray-800 mb-2">Explain how a hydrogen fuel cell produces electricity.</p>
                <p class="text-sm text-gray-600 mb-4 italic leading-relaxed">Include: the reactions at the anode and cathode, the half-equations, how electrons move through the external circuit, and one advantage of using hydrogen fuel cells compared to burning fossil fuels.</p>
                <textarea id="q4-input" class="w-full h-40 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Explain the process..."></textarea>
                <div id="q4-feedback" class="mt-4 hidden p-4 rounded-lg"></div>
            </section>

            <!-- Question 5 -->
            <section class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Question 5 (6 marks) – Rechargeable and Non-Rechargeable Cells</h3>
                <p class="font-semibold text-gray-800 mb-2">Compare rechargeable cells and non-rechargeable cells.</p>
                <p class="text-sm text-gray-600 mb-4 italic leading-relaxed">Consider: energy changes in the reactions, whether the reactions are reversible, typical uses of each type of cell, and environmental impacts.</p>
                <textarea id="q5-input" class="w-full h-40 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Compare the two types of cells..."></textarea>
                <div id="q5-feedback" class="mt-4 hidden p-4 rounded-lg"></div>
            </section>

            <!-- Submit Button -->
            <div class="flex flex-col items-center gap-4 mt-12 pb-20">
                <button id="submit-btn" onclick="submitAssessment()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-lg flex items-center gap-3 transition-transform active:scale-95">
                    <span id="submit-btn-text">Submit for AI Grading</span>
                    <div id="loading-spinner" class="spinner hidden"></div>
                </button>
                <p id="error-message" class="text-red-600 text-sm hidden font-semibold text-center max-w-md"></p>
                <p class="text-gray-500 text-sm">Automated grading takes approximately 10-15 seconds.</p>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">AI Configuration</h2>
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-4">Enter your Google Gemini API Key if you are running this locally. In this preview environment, the key is handled automatically.</p>
                <input type="password" id="api-key-input" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none mb-4" placeholder="Gemini API Key">
                <button onclick="saveKey()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Save & Close</button>
                <p id="key-status" class="text-xs mt-3 text-center text-gray-500"></p>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 text-center no-scrollbar overflow-y-auto max-h-[90vh]">
                <h2 class="text-3xl font-black text-gray-900 mb-2">Final Report</h2>
                <div id="grade-badge" class="inline-block px-8 py-4 rounded-2xl text-white text-5xl font-black mb-6 shadow-xl">?</div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <p class="text-gray-500 text-xs uppercase tracking-wider font-bold">Raw Score</p>
                        <p id="final-score" class="text-2xl font-bold text-gray-800">0 / 28</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <p class="text-gray-500 text-xs uppercase tracking-wider font-bold">Percentage</p>
                        <p id="final-percent" class="text-2xl font-bold text-gray-800">0%</p>
                    </div>
                </div>

                <div id="grade-description" class="text-gray-600 mb-8 leading-relaxed"></div>
                
                <button onclick="closeModal()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold hover:bg-black transition-all">
                    Review Question Feedback
                </button>
            </div>
        </div>

    </main>

    <script>
        require('dotenv').config()
        console.log(process.env)
        // Use empty string to allow environment to provide key.
        const apiKey = ""; 
        let manualApiKey = ""; // Local state for manual entry override
        let timerSeconds = 30 * 60;
        let timerInterval;
        let isTestStarted = false;

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('api-key-input').value = manualApiKey;
            }
        }

        function saveKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                manualApiKey = val;
                document.getElementById('key-status').innerText = "✓ Key saved for this session.";
                document.getElementById('key-status').className = "text-xs mt-3 text-center text-green-600 font-medium";
                setTimeout(toggleSettings, 800);
            } else {
                alert("Please enter a valid Gemini API key.");
            }
        }

        function updateTimer() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const timerEl = document.getElementById('timer-display');
            if (timerEl) {
                timerEl.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            if (timerSeconds <= 0) {
                clearInterval(timerInterval);
                submitAssessment(true);
            }
            if (timerSeconds < 300 && timerEl) {
                timerEl.classList.replace('bg-blue-600', 'bg-red-600');
            }
            timerSeconds--;
        }

        function startTest() {
            isTestStarted = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('questions-container').classList.remove('opacity-40', 'pointer-events-none');
            document.getElementById('status-msg').innerText = "Worksheet active. Assessment in progress.";
            timerInterval = setInterval(updateTimer, 1000);
        }

        async function callGemini(prompt) {
            const systemPrompt = `You are an expert GCSE Chemistry Examiner. 
            Grade the following student response out of the marks provided. 
            STRICT RULE: If the student response is empty, blank, contains only whitespace, or is completely irrelevant, you MUST award exactly 0 marks. 
            Do not award marks for the prompt's provided reference data. Only award marks based on what the student wrote.
            Provide a JSON response: 
            { "marks": number, "feedback": "string explaining marks lost or gained", "isCorrect": boolean }`;

            const activeKey = manualApiKey || apiKey;
            
            let retries = 5;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (response.status === 403 || response.status === 401) {
                            throw new Error(`API Error: ${errorData.error?.message || "Invalid API Key"}. Click gear icon to set key.`);
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) throw new Error("Invalid response structure from AI");
                    return JSON.parse(content);
                } catch (error) {
                    retries--;
                    if (retries === 0 || error.message.includes("API Error")) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function submitAssessment(auto = false) {
            const errorEl = document.getElementById('error-message');
            const submitText = document.getElementById('submit-btn-text');
            const spinner = document.getElementById('loading-spinner');
            const submitBtn = document.getElementById('submit-btn');

            errorEl.classList.add('hidden');

            if (auto) alert("Time is up! Your work is being submitted.");
            
            clearInterval(timerInterval);
            if (spinner) spinner.classList.remove('hidden');
            submitBtn.disabled = true;
            if (submitText) submitText.innerText = "AI Grading in Progress...";

            const answers = {
                q1: document.getElementById('q1-input').value.trim(),
                q2: document.getElementById('q2-input').value.trim(),
                q3: document.getElementById('q3-input').value.trim(),
                q4: document.getElementById('q4-input').value.trim(),
                q5: document.getElementById('q5-input').value.trim()
            };

            const gradingPrompts = [
                `Question: Compare reactivity of Mg, Zn, Fe method (6 marks). Student response: "${answers.q1}"`,
                `Question: Explain exothermic reactions (4 marks). Student response: "${answers.q2}"`,
                `Question: Bond energy calculations for Haber process (6 marks). 
                 Target Answer Info: Reactants break = 2253 kJ/mol; Products form = 2346 kJ/mol; Energy change = -93 kJ/mol; Exothermic.
                 Student response to grade: "${answers.q3}"`,
                `Question: Hydrogen fuel cells electricity production (6 marks). Student response: "${answers.q4}"`,
                `Question: Compare rechargeable and non-rechargeable cells (6 marks). Student response: "${answers.q5}"`
            ];

            try {
                const results = await Promise.all(gradingPrompts.map(p => callGemini(p)));
                displayResults(results);
            } catch (err) {
                console.error(err);
                errorEl.innerText = err.message || "An unexpected error occurred during grading.";
                errorEl.classList.remove('hidden');
                submitBtn.disabled = false;
                if (submitText) submitText.innerText = "Retry Submission";
            } finally {
                const finalSpinner = document.getElementById('loading-spinner');
                if (finalSpinner) finalSpinner.classList.add('hidden');
            }
        }

        function getGrade(percent) {
            if (percent < 10) return { g: "U", c: "bg-red-600" };
            if (percent < 20) return { g: "1", c: "bg-red-500" };
            if (percent < 30) return { g: "2", c: "bg-orange-600" };
            if (percent < 40) return { g: "3", c: "bg-orange-500" };
            if (percent < 45) return { g: "4", c: "bg-yellow-600" };
            if (percent < 50) return { g: "5", c: "bg-yellow-500" };
            if (percent < 60) return { g: "6", c: "bg-green-400" };
            if (percent < 70) return { g: "7", c: "bg-green-500" };
            if (percent < 75) return { g: "8", c: "bg-green-600" };
            return { g: "9", c: "bg-indigo-600" };
        }

        function displayResults(results) {
            let totalMarks = 0;
            const maxMarks = 28;

            results.forEach((res, index) => {
                totalMarks += res.marks;
                const feedbackDiv = document.getElementById(`q${index + 1}-feedback`);
                if (feedbackDiv) {
                    feedbackDiv.classList.remove('hidden');
                    feedbackDiv.className = `mt-4 p-4 rounded-lg border ${res.marks >= 3 ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`;
                    feedbackDiv.innerHTML = `
                        <div class="flex justify-between font-bold mb-1">
                            <span class="text-gray-800">Examiner Feedback:</span>
                            <span class="text-blue-700">${res.marks} / ${[6, 4, 6, 6, 6][index]} marks</span>
                        </div>
                        <p class="text-gray-700 text-sm leading-relaxed">${res.feedback}</p>
                    `;
                }
            });

            const percentage = Math.round((totalMarks / maxMarks) * 100);
            const gradeInfo = getGrade(percentage);

            document.getElementById('final-score').innerText = `${totalMarks} / ${maxMarks}`;
            document.getElementById('final-percent').innerText = `${percentage}%`;
            const badge = document.getElementById('grade-badge');
            badge.innerText = `Grade ${gradeInfo.g}`;
            badge.className = `inline-block px-8 py-4 rounded-2xl text-white text-5xl font-black mb-6 shadow-xl ${gradeInfo.c}`;
            
            let desc = "";
            if (percentage >= 70) desc = "Outstanding work. You demonstrate a comprehensive understanding of energy changes and chemical cell technology.";
            else if (percentage >= 45) desc = "Good standard. Review the specific feedback on your answers to ensure you're using all required technical terminology.";
            else desc = "Focus your revision on calculating bond energies and explaining the electrochemical processes in fuel cells.";
            
            document.getElementById('grade-description').innerText = desc;
            document.getElementById('result-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
            const submitText = document.getElementById('submit-btn-text');
            if (submitText) submitText.innerText = "Assessment Complete";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>